
Hands on: Recursive retriever
=============================

  - concept of Recursive Retriever is not only explore the most relevant nodes but also
    the node relationships.
    
![image](https://github.com/user-attachments/assets/198eb4d8-18cc-4035-8d46-6bb0ddcb5818)


![image](https://github.com/user-attachments/assets/3fe5fdaa-fa25-4f51-a14e-17e04b84ea84)


- some of nodes have text chunk , some of them have tabular info and some where we store
  the relation ship of that node with other node.
- there will be index nodes for a table and that table will be stored as a panda table and it will
  be used as a query Engine.
- we are going to create a sql database query Engine over these tables so that we can query
  specific information from these tables.
 - but the question is how does the retriever enter the query Engine- it can go via
   some of the text chunks which is related to some of the information in the query Engine
   or it can directly enter in to one of the queryEngine using recursive Retriever query Engine.
 - Given any let say user query that might required a information present in the textual chunks
   and some information coming from the tables , and then final llm will be able to answer and
   generate comprehensive answer based on the information present in textual chunks and as well as
   information coming from these tables.
 - so where we do see hierarchy and relation ship between the text chunks and the chunks contains
   table that is what recursive retriever all about.
   
Step 1- Environment:
====================

![image](https://github.com/user-attachments/assets/19b1e971-5474-44bb-9172-a6bfed390216)

![image](https://github.com/user-attachments/assets/fde2aa6c-ee9c-4a22-9229-b22613b14c34)
![image](https://github.com/user-attachments/assets/3a9d7fb2-27af-4331-b20a-fa7c613d6d07)


Step-2 download data:
=====================

![image](https://github.com/user-attachments/assets/72fce160-3ed0-4ad5-a510-9a13f6f5d0e9)


Step-3 load data:
==================

![image](https://github.com/user-attachments/assets/ce6e15d7-7de9-4eb3-8938-e52115db5937)

copy the path of the upload pdf from collab and add the path.

Step-4 get tables from pdf:
============================

![image](https://github.com/user-attachments/assets/b21fb373-aafb-4b37-a988-73c4b809ac65)


- explicitly mention to retrieve the tables present in page 3,4,5,25 - 4 pages contains 6
  above tables.
![image](https://github.com/user-attachments/assets/f20a5e89-fa2e-4979-9a1a-853cd520c850)

25 page

![image](https://github.com/user-attachments/assets/25c2417f-caf4-47d7-869c-8b70e963c8cb)

Step-5: Define pandas for above tables:
=========================================

![image](https://github.com/user-attachments/assets/69da4bd4-822f-48ca-beda-689838d9098c)

- pandasQueryEngine helps us to query over the pandas table.
- passing llm to the pandasQueryEngine.
- Ask the query in natural language to the pandasQuery

  ![image](https://github.com/user-attachments/assets/0062e16f-8c65-42b9-8b3b-7dadfdc3804d)


Step-6: Build vector Index:
===========================

- i want to create a index over all the query Engine.
- for that i need to create a some sort of metadata - which is nothing but
  information about each of the query engines. what information it contains.
  what is that information present in these tables.
  here create a metadata information for  the each of the query engine.
 - creat a index node basically if i referback to original, pandasQueryEngine
   on top of it create node. this is the index node that i going to create.
   the retrieval engine which we create able to retrieve the index node from which
   we are going to query tables. it cannot directly retrieve the quey Engine.
   it only able to retrieve the index node. from each of the index nodes, recursively another
   query will be passed on to the queryEngine present in each of the index nodes and information
   coming from th**at will be collectively passed to llm that is recursive retriever**. 

![image](https://github.com/user-attachments/assets/ec1b4bc9-b96b-4bde-90f8-21a02f3c0293)

![image](https://github.com/user-attachments/assets/0dc29e56-a7df-429f-9201-3a3628ff2fc7)


 - 6 index nodes list , 1 for each of the query engine, passing the index of query Engine.
 - node to query engine mapping -> which index node has which query engine.
 - now construct top level vector store index  - **doc_nodes** is textual nodes and
   **df_nodes** is the index node of database , we are creating combined index.
 - basically the response either comes from text chunk or the index node which is retrieve the
   database engine.
 - it could be that response also be text chunk + database query engines.

   ![image](https://github.com/user-attachments/assets/8ed16414-7de1-4bf1-a1e3-0cfd225c36fb)

Step-7:Recursive Retriever:
===========================

  - finally create the base query Engine , this base query engine only know the text(doc_nodes)
    chunk not database.
    

![image](https://github.com/user-attachments/assets/d7f5b4a3-97cd-4783-98d8-e449a67282ec)

recursive node df_id_query_mapping has mapping of both text and database query Engine.

![image](https://github.com/user-attachments/assets/a9a1617a-a170-49a3-b8b8-6c8611a06a49)


Step-8:Query:
==============

![image](https://github.com/user-attachments/assets/10214679-6a97-4e5b-9669-c2e17aa53177)

- recursive retriever some how able to retriever which query engine to use
  based on the summary.
 - Automatically switch from index node to text nodes. for .eg if any information
   present in db , it switch to text node.

 ![image](https://github.com/user-attachments/assets/13b36f72-3e66-4af2-9b0e-2f8048396141)
